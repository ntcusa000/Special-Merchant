name: Sync Google Sheet to CSV

on:
  workflow_dispatch:
  schedule:
    - cron: "*/5 * * * *" # every 5 minutes

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download CSV (skip commit if blocked)
        run: |
          set -euo pipefail
          mkdir -p data

          url="https://docs.google.com/spreadsheets/d/1NRrs9PXp_1XfSAx3bDxnpII0X_YMWHWBLEl5Kn_qTuM/export?format=csv&gid=0"
          dl="data/.download.csv"

          # Download (if blocked/rate-limited/error, skip commit)
          if ! curl -L --fail --silent --show-error \
            --connect-timeout 10 --max-time 30 \
            "$url" -o "$dl"; then
            echo "Download failed (likely rate-limited/blocked). Skip commit."
            exit 0
          fi

          # Skip empty file
          if [ ! -s "$dl" ]; then
            echo "Downloaded file is empty. Skip commit."
            exit 0
          fi

          # If HTML/login/permission page returned, skip commit
          head_chunk="$(head -c 2048 "$dl" | tr '[:upper:]' '[:lower:]')"
          if echo "$head_chunk" | grep -qE '<!doctype html|<html|accounts\.google\.com|signin|permission|access denied'; then
            echo "Looks like HTML/blocked response. Skip commit."
            exit 0
          fi

          # (Optional but recommended) Ensure expected header exists to avoid committing wrong content
          first_line="$(head -n 1 "$dl")"
          echo "$first_line" | grep -q "商家名稱" || { echo "Header mismatch. Skip commit."; exit 0; }

          # Normalize line endings to avoid false diffs
          python - << 'PY'
          from pathlib import Path
          p = Path("data/.download.csv")
          b = p.read_bytes().replace(b"\r\n", b"\n")
          p.write_bytes(b)
          PY

          mv "$dl" data/sheet.csv

      - name: Commit if changed
        run: |
          set -euo pipefail

          if git diff --quiet; then
            echo "No changes."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add data/sheet.csv
          git commit -m "chore: sync sheet.csv from Google Sheet"
          git push
