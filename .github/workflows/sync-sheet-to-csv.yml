name: Sync Google Sheet to CSV

on:
  workflow_dispatch:
  schedule:
    - cron: "*/5 * * * *" # 每 5 分鐘

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download CSV (skip commit if blocked)
        run: |
          set -euo pipefail
          mkdir -p data
          tmp="$(mktemp)"

          url="https://docs.google.com/spreadsheets/d/1NRrs9PXp_1XfSAx3bDxnpII0X_YMWHWBLEl5Kn_qTuM/export?format=csv&gid=0"

          # 下載（失敗就直接退出：不 commit）
          if ! curl -L --fail --silent --show-error \
            --connect-timeout 10 --max-time 30 \
            "$url" -o "$tmp"; then
            echo "Download failed (likely rate-limited/blocked). Skip commit."
            exit 0
          fi

          # 基本檢查：空檔就跳過
          if [ ! -s "$tmp" ]; then
            echo "Downloaded file is empty. Skip commit."
            exit 0
          fi

          # 被擋的常見型態：回傳 HTML（登入/權限/驗證頁）
          # 取前 2KB 檢查是否含 html 特徵
          head_chunk="$(head -c 2048 "$tmp" | tr '[:upper:]' '[:lower:]')"
          if echo "$head_chunk" | grep -qE '<!doctype html|<html|accounts\.google\.com|signin|權限|permission|access denied'; then
            echo "Looks like HTML/blocked response. Skip commit."
            exit 0
          fi

          # 換行正規化，避免 CRLF 差異造成假變更
          python - << 'PY'
          import pathlib
          p = pathlib.Path("data/sheet.csv.tmp")
          b = pathlib.Path("'"$tmp"'").read_bytes().replace(b"\r\n", b"\n")
          p.write_bytes(b)
          PY

          mv data/sheet.csv.tmp data/sheet.csv

      - name: Commit if changed
        run: |
          set -euo pipefail
          if git diff --quiet; then
            echo "No changes."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add data/sheet.csv
          git commit -m "chore: sync sheet.csv from Google Sheet"
          git push
