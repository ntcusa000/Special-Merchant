name: Sync Google Sheet to CSV

on:
  workflow_dispatch:
  schedule:
    - cron: "*/5 * * * *" # every 5 minutes

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download CSV (skip commit if blocked)
        shell: bash
        run: |
          set -euo pipefail
          echo "Start download..."

          mkdir -p data

          url="https://docs.google.com/spreadsheets/d/1NRrs9PXp_1XfSAx3bDxnpII0X_YMWHWBLEl5Kn_qTuM/export?format=csv&gid=0"
          dl="data/.download.csv"

          # Download (if blocked/rate-limited/error, skip commit)
          if ! curl -L --fail --silent --show-error \
            --connect-timeout 10 --max-time 30 \
            "$url" -o "$dl"; then
            echo "Download failed (likely rate-limited/blocked). Skip."
            exit 0
          fi

          echo "Downloaded bytes: $(wc -c < "$dl")"
          echo "First 1 line:"
          head -n 1 "$dl" || true

          # Skip empty file
          if [ ! -s "$dl" ]; then
            echo "Downloaded file is empty. Skip."
            exit 0
          fi

          # If HTML/login/permission page returned, skip commit
          head_chunk="$(head -c 2048 "$dl" | tr '[:upper:]' '[:lower:]')"
          if echo "$head_chunk" | grep -qE '<!doctype html|<html|accounts\.google\.com|signin|permission|access denied'; then
            echo "Looks like HTML/blocked response. Skip."
            exit 0
          fi

          # Ensure expected header exists to avoid committing wrong content
          first_line="$(head -n 1 "$dl")"
          echo "$first_line" | grep -q "商家名稱" || { echo "Header mismatch. Skip."; exit 0; }

          # Normalize line endings to avoid false diffs
          python - << 'PY'
          from pathlib import Path
          p = Path("data/.download.csv")
          b = p.read_bytes().replace(b"\r\n", b"\n")
          p.write_bytes(b)
          PY

          mv "$dl" data/sheet.csv
          echo "Saved as data/sheet.csv"
          ls -lah data
          echo "Preview:"
          head -n 3 data/sheet.csv || true

      - name: Commit if changed (includes new files)
        shell: bash
        run: |
          set -euo pipefail

          if [ ! -f data/sheet.csv ]; then
            echo "data/sheet.csv not created. Nothing to commit."
            exit 0
          fi

          # Stage the file so new/untracked file is included in change detection
          git add data/sheet.csv

          # Now detect changes (staged or not)
          if [ -z "$(git status --porcelain)" ]; then
            echo "No changes."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git commit -m "chore: sync sheet.csv from Google Sheet"
          git push
          echo "Committed and pushed."
